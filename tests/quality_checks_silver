--crm_cust_info

-- to check unique primary key
select cst_id, count(*) as count from 
bronze.crm_cust_info 
group by cst_id
HAVING count(*) > 1 or cst_id is null;

--gives us unique records
SELECT * FROM 
(select *,
ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY cst_create_date DESC) as flag
from 
bronze.crm_cust_info 
)t
WHERE t.flag = 1

--removes the unwanted spaces
select 
cst_id, cst_key, 
trim(cst_firstname) as cst_firstname,trim(cst_lastname) as cst_lastname,
cst_marital_status, cst_gndr, cst_create_date
from bronze.crm_cust_info;

--meaningful values for gender and marital status
select distinct cst_gndr 
from bronze.crm_cust_info;

SELECT 
cst_id,
cst_key, 
ISNULL(trim(cst_firstname),'n/a' )as cst_firstname,
ISNULL(trim(cst_lastname),'n/a') as cst_lastname,
CASE WHEN UPPER(TRIM(cst_gndr)) = 'M' THEN 'Male' 
     WHEN UPPER(TRIM(cst_gndr)) = 'F' then 'Female' 
     else 'n/a' end as cst_gndr, 
CASE WHEN UPPER(TRIM(cst_marital_status)) = 'M' THEN 'Married' 
     WHEN UPPER(TRIM(cst_marital_status)) = 'S' then 'Single' 
     else 'n/a' end as cst_marital_status,
cst_create_date
FROM 
(
    select *,
    ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY cst_create_date DESC) as flag
    from 
    bronze.crm_cust_info 
)t
WHERE t.flag = 1

-------------------------------------------------------------------------------------
--crm_prd_info

-- to check unique primary key
select prd_id, count(*) as count from 
bronze.crm_prd_info 
group by prd_id
HAVING count(*) > 1 or prd_id is null;

--check unique records
SELECT * FROM 
(select *,
ROW_NUMBER() OVER (PARTITION BY prd_id ORDER BY prd_start_dt DESC) as flag
from 
bronze.crm_prd_info 
)t
WHERE t.flag <> 1

--check unwanted space
select prd_key
from bronze.crm_prd_info
where prd_key <> trim(prd_key)

--meaningful values for prd_line
select distinct prd_line
from bronze.crm_prd_info;

--check for start and end date
select 
prd_start_dt,
prd_end_dt
from bronze.crm_prd_info
where prd_start_dt > prd_end_dt 

--prd_key can be split into two columns, first 5 char are cat_id
select 
prd_id,
REPLACE(SUBSTRING(prd_key, 1, 5),'-','_' )as cat_id,
SUBSTRING(prd_key, 7, LEN(prd_key)) as prd_key,
prd_nm,
ISNULL(prd_cost,0) as prd_cost,
CASE WHEN UPPER(TRIM(prd_line)) = 'M' THEN 'Mountain' 
     WHEN UPPER(TRIM(prd_line)) = 'R' then 'Road' 
     WHEN UPPER(TRIM(prd_line)) = 'S' then 'other Sales' 
     WHEN UPPER(TRIM(prd_line)) = 'T' then 'Touring' 
     else 'n/a' end as prd_line, 
CAST(prd_start_dt AS DATE) as prd_start_dt,
CAST(LEAD(prd_start_dt) OVER (PARTITION BY prd_key ORDER BY prd_start_dt)-1 as DATE) as prd_end_dt
from bronze.crm_prd_info


-------------------------------------------------------------------------------------

INSERT INTO silver.crm_sales_details(
    sls_ord_num,
    sls_prd_key,
    sls_cust_id,
    sls_order_dt,
    sls_ship_dt,
    sls_due_dt,
    sls_sales,
    sls_quantity,
    sls_price
)

select 
sls_ord_num,
sls_prd_key,
sls_cust_id,
CASE WHEN sls_order_dt = 0 OR LEN(sls_order_dt) <> 8 THEN NULL
     ELSE CAST(CAST(sls_order_dt AS varchar) AS DATE) END AS sls_order_dt,
CASE WHEN sls_ship_dt = 0 OR LEN(sls_ship_dt) <> 8 THEN NULL
     ELSE CAST(CAST(sls_ship_dt AS varchar) AS DATE) END AS sls_ship_dt,
CASE WHEN sls_due_dt = 0 OR LEN(sls_due_dt) <> 8 THEN NULL
     ELSE CAST(CAST(sls_due_dt AS varchar) AS DATE) END AS sls_due_dt,   

CASE WHEN  sls_sales is null or sls_sales <= 0 or sls_sales <> (sls_quantity * ABS(sls_price))
     THEN (sls_quantity * ABS(sls_price)) 
     ELSE sls_sales end as sls_sales,
sls_quantity,
CASE WHEN sls_price <= 0 or sls_price is null 
     THEN (sls_sales) / NULLIF(sls_quantity,0) 
     ELSE sls_price end as sls_price
     
 from bronze.crm_sales_details
